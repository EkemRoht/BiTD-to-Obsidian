"use strict";const B=require("obsidian");function $(e,o,s){return`<span class="skill-text">${y(o,s)} ${e}</span>`}function y(e,o){let s="";for(let t=0;t<o;t++)s+=t<e?"●":"○";return`<span class="mono-font">${s}</span>`}function L(e,o){const s=document.createElement("div");s.className="progress-bar";for(let t=0;t<o;t++){const i=document.createElement("div");i.className="progress-segment",t<e?i.classList.add("filled"):i.classList.add("empty"),s.appendChild(i)}return s}function T(e){const o=document.createElement("div");return o.innerHTML=e,o}function S(e){e.registerMarkdownCodeBlockProcessor("skill",M)}function M(e,o,s){console.log("Обрабатываем блок skill:",e),e.split(`
`).forEach(i=>{const a=/^(\S+)\s(\d+)\/(\d+)$/,p=i.match(a);if(p){const[,m,l,c]=p,n=$(m,parseInt(l),parseInt(c)),r=T(n);r.onclick=()=>{const u=l>0?`${l}d6 k1`:"2d6 kl1";navigator.clipboard.writeText(`/roll message:${u} !${m}`).then(()=>{r.classList.add("copied"),setTimeout(()=>r.classList.remove("copied"),1e3)})},o.appendChild(r)}})}function b(e){e.registerMarkdownCodeBlockProcessor("skillgroup",P)}function P(e,o){console.log("Обрабатываем блок skillgroup:",e);const s=e.split(`
`);let t=0,i=0,a="",p=0;if(s.length>0){const l=s[0].trim(),c=/^(.+?)\s+exp:(\d+)$/,n=l.match(c);n&&(a=n[1],p=parseInt(n[2],10),s.shift())}const m=document.createElement("div");if(s.forEach(l=>{const c=/^([А-Яа-яA-Za-z]+)\s(\d+)\/(\d+)$/,n=l.match(c);if(n){const[,r,u,w]=n,h=parseInt(u,10),C=parseInt(w,10),f=$(r,h,C),g=T(f);g.onclick=()=>{const x=h>0?`${h}d6 k1`:"2d6 kl1";navigator.clipboard.writeText(`/roll message:${x} !${r}`).then(()=>{g.classList.add("copied"),setTimeout(()=>g.classList.remove("copied"),1e3)})},m.appendChild(g),h>=1&&t++,i=C}}),a){const l=y(t,i),c=document.createElement("div");c.classList.add("skillgroup");const n=document.createElement("h3");n.innerHTML=`${a} ${l}`,n.onclick=()=>{const u=t>0?`${t}d6 k1`:"2d6 kl1";navigator.clipboard.writeText(`/roll message:${u} !${a}`).then(()=>{n.classList.add("copied"),setTimeout(()=>n.classList.remove("copied"),1e3)})},c.appendChild(n);const r=L(p,6);c.appendChild(r),o.appendChild(c)}o.appendChild(m)}function N(e){e.registerMarkdownCodeBlockProcessor("clock",I)}function I(e,o,s){var c,n;console.log("Обрабатываем блок clock:",e);const t=e.split(`
`);if(t.length<2)return;const i=t[0].trim(),a=((c=t[1])==null?void 0:c.trim())||"Без названия",p=((n=t[2])==null?void 0:n.trim())||"",m=/^(\d+)\/(\d+)\s+dices:\s*(\d+)$/,l=i.match(m);if(l){const[,r,u,w]=l,h=parseInt(r,10),C=parseInt(u,10),f=`/roll message:${w}d6 k1`,g=L(h,C),x=document.createElement("h3");x.innerHTML=`${a}`;const E=document.createElement("p");E.textContent=p;const k=document.createElement("pre");k.className="language-copy",k.setAttribute("tabindex","0");const v=document.createElement("code");v.className="is-loaded language-copy",v.setAttribute("data-line","0"),v.textContent=f;const d=document.createElement("button");d.className="copy-code-button",d.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy">
        <rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect>
        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
      </svg>
    `,d.onclick=()=>{navigator.clipboard.writeText(f).then(()=>{d.classList.add("copied"),d.innerHTML="Скопировано!",setTimeout(()=>{d.classList.remove("copied"),d.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy">
              <rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect>
              <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
            </svg>
          `},2e3)})},k.appendChild(v),k.appendChild(d),o.appendChild(x),o.appendChild(g),o.appendChild(E),o.appendChild(k)}}class H extends B.Plugin{onload(){console.log("Плагин загружен!"),this.loadStylesFromFile(),S(this),b(this),N(this)}onunload(){console.log("Плагин выгружен!")}async loadStylesFromFile(){const o=`${this.manifest.dir}/styles.css`;try{const s=await this.app.vault.adapter.read(o),t=document.createElement("style");t.textContent=s,document.head.appendChild(t)}catch(s){console.error("Ошибка при загрузке CSS:",s)}}}module.exports=H;
